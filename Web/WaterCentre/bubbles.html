<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bubbles</title>
    <style>
        .bubble {
            position: absolute;
        }
    </style>
</head>
<body>
<script src="js/jquery-2.2.0.js"></script>
<script src="js/tree.js"></script>
<script>
    'use strict';

    const offset = 10;
    const bubbleLength = 60;

    var Bubble = {
        dic: {},
        xMax: 0,
        yMax: 0,
        initArray: [],

        create: function (id, innerHTML, direction, distance, parent) {
            Bubble.dic[id] = {
                innerHTML: innerHTML,
                direction: direction,
                distance: distance,
                parent: parent
            };
        },

        getRect: function (id) {
            var bubble = Bubble.dic[id];

            if (!bubble.xTo) {
                bubble.xTo = bubble.yTo = bubbleLength;

                if (bubble.parent) {
                    var parentRect = Bubble.getRect(bubble.parent);

                    if (bubble.direction.match(/left|right/)) {
                        bubble.xTo += (parentRect.xTo + bubble.distance);
                        bubble.yTo = parentRect.yTo;
                    } else {
                        bubble.xTo = parentRect.xTo;
                        bubble.yTo += (parentRect.yTo + bubble.distance);
                    }
                } else {
                    Bubble.initArray.push(id);
                }
            }

            Bubble.xMax = Math.max(Bubble.xMax, bubble.xTo);
            Bubble.yMax = Math.max(Bubble.yMax, bubble.yTo);
            return {
                xTo: bubble.xTo,
                yTo: bubble.yTo
            }
        },

        display: function () {
            for (var id in Bubble.dic) {
                Bubble.getRect(id)
            }

            var xTree = Tree.create(0, Bubble.xMax * 2);
            var yTree = Tree.create(0, Bubble.yMax * 2);

            for (var i = 0; i < Bubble.initArray; i++) {
                id = Bubble.initArray[i];
                var position = positionPop(
                        Bubble.xMax - bubbleLength, Bubble.xMax, Bubble.yMax - bubbleLength, Bubble.yMax);
                place(id, position);
            }

            for (id in Bubble.dic) {
                place(id);
            }

            function positionPop(leftFrom, leftTo, topFrom, topTo, prevCommand, attemptTime) {
                var overlapsX = [];
                var overlapsY = [];

                Tree.search(xTree, leftFrom, leftTo, function (x) {
                            overlapsX.push(x)
                        }
                );

                Tree.search(yTree, topFrom, topTo, function (y) {
                            overlapsY.push(y)
                        }
                );

                function isOverlapped(a, b) {
                    a.sort();
                    b.sort();

                    for (var iA = 0, iB = 0; iA < a.length && iB < b.length;) {
                        if (a[iA] < b[iB]) {
                            iA++;
                        } else if (a[iA] > b[iB]) {
                            iB++;
                        } else {
                            return true;
                        }
                    }
                }

                if (!isOverlapped(overlapsX, overlapsY)) {
                    Tree.insert(xTree, leftFrom, leftTo, id);
                    Tree.insert(yTree, topFrom, topTo, id);

                    return {
                        left: leftFrom,
                        top: topFrom
                    }
                }

                else {
                    attemptTime = attemptTime || 0;
                    attemptTime++;

                    var command = Math.round(attemptTime * 0.618 % 1 * 3);
                    if ((command + 2) % 4 === prevCommand) {
                        command = (command + 1 ) % 4;
                    }

                    switch (command) {
                        case 0:
                            topFrom -= offset;
                            break;
                        case 1:
                            leftFrom += offset;
                            break;
                        case 2:
                            topFrom += offset;
                            break;
                        case 3:
                            leftFrom -= offset;
                            break;
                    }

                    return positionPop(
                            leftFrom, leftFrom + bubbleLength, topFrom, topFrom + bubbleLength, command, attemptTime);
                }
            }

            function place(id, position) {
                var element = document.getElementById(id);
                if (element) {
                    return {
                        left: parseInt(element.style.left),
                        top: parseInt(element.style.top)
                    }
                }

                var bubble = Bubble.dic[id];
                if (position) {
                    $(bubble.innerHTML)
                            .attr('id', id)
                            .addClass('bubble')
                            .css({
                                left: position.left,
                                top: position.top
                            })
                            .appendTo(document.body);
                } else {
                    position = place(bubble.parent);
                    var leftFrom = position.left;
                    var topFrom = position.top;

                    switch (bubble.direction) {
                        case 'bottom':
                            topFrom -= bubble.distance;
                            break;
                        case 'left':
                            leftFrom += bubble.distance;
                            break;
                        case 'top':
                            topFrom += bubble.distance;
                            break;
                        case 'right':
                            leftFrom -= bubble.distance;
                            break;
                    }

                    place(id, positionPop(leftFrom, leftFrom + bubbleLength, topFrom, topFrom + bubbleLength));
                }
            }
        }
    };

</script>
<script>
    const distance = 100;

    /* Sample */
    Bubble.create(1, '<div>1</div>');
    Bubble.create(2, '<div>2</div>', 'bottom', distance, 1);
    Bubble.create(3, '<div>3</div>', 'top', distance, 1);
    Bubble.create(4, '<div>4</div>', 'left', distance, 1);
    Bubble.create(5, '<div>5</div>', 'right', distance, 1);
    Bubble.create(6, '<div>6</div>', 'right', distance, 5);
    Bubble.create(7, '<div>7</div>', 'bottom', distance, 6);
    /* end */

    Bubble.display();
</script>
</body>
</html>